{% extends "base.html" %}

{% block title %}Processing - Goswami Whisper{% endblock %}

{% block extra_css %}
<style>
    .progress-container {
        max-width: 500px;
        margin: 0 auto;
    }

    .progress {
        height: 30px;
        border-radius: 15px;
        background-color: #e9ecef;
        overflow: hidden;
    }

    .progress-bar {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        transition: width 0.5s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
    }

    .status-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .status-icon.pending { color: #6c757d; }
    .status-icon.downloading { color: #17a2b8; }
    .status-icon.transcribing { color: var(--primary-color); }
    .status-icon.formatting { color: #28a745; }
    .status-icon.indexing { color: #ffc107; }
    .status-icon.completed { color: #28a745; }
    .status-icon.error { color: #dc3545; }

    .pulse {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .time-info {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding: 0 10px;
    }

    .step {
        text-align: center;
        flex: 1;
        position: relative;
    }

    .step::after {
        content: '';
        position: absolute;
        top: 15px;
        left: 50%;
        width: 100%;
        height: 2px;
        background-color: #e9ecef;
        z-index: 0;
    }

    .step:last-child::after {
        display: none;
    }

    .step-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        position: relative;
        z-index: 1;
        margin-bottom: 5px;
    }

    .step.active .step-circle {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
    }

    .step.completed .step-circle {
        background-color: #28a745;
        color: white;
    }

    .step-label {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .step.active .step-label {
        color: var(--primary-color);
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-hourglass-split me-2"></i>Processing Transcription
                </h4>
            </div>
            <div class="card-body text-center py-5">
                <!-- Status Icon -->
                <div id="statusIcon" class="status-icon transcribing pulse">
                    <i class="bi bi-mic-fill"></i>
                </div>

                <!-- Status Text -->
                <h3 id="statusText" class="mb-3">Initializing...</h3>

                <!-- File Name -->
                <p class="text-muted mb-4">
                    <i class="bi bi-file-earmark-music me-1"></i>
                    <span id="fileName">{{ transcription.filename or transcription.source_url or 'Processing...' }}</span>
                </p>

                <!-- Progress Bar -->
                <div class="progress-container mb-3">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar"
                             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Time Info -->
                <div class="time-info mb-4">
                    <span id="timeInfo">
                        <i class="bi bi-clock me-1"></i>
                        <span id="currentPosition">0:00</span> / <span id="totalDuration">--:--</span>
                    </span>
                </div>

                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step" id="step-downloading">
                        <div class="step-circle">1</div>
                        <div class="step-label">Download</div>
                    </div>
                    <div class="step" id="step-transcribing">
                        <div class="step-circle">2</div>
                        <div class="step-label">Transcribe</div>
                    </div>
                    <div class="step" id="step-formatting">
                        <div class="step-circle">3</div>
                        <div class="step-label">Format</div>
                    </div>
                    <div class="step" id="step-indexing">
                        <div class="step-circle">4</div>
                        <div class="step-label">Index</div>
                    </div>
                    <div class="step" id="step-completed">
                        <div class="step-circle">âœ“</div>
                        <div class="step-label">Done</div>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="errorContainer" class="alert alert-danger mt-4" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const transcriptionId = {{ transcription.id }};
    let pollInterval;

    const statusIcons = {
        'pending': 'bi-hourglass',
        'downloading': 'bi-cloud-download',
        'transcribing': 'bi-mic-fill',
        'formatting': 'bi-file-text',
        'indexing': 'bi-search',
        'completed': 'bi-check-circle-fill',
        'error': 'bi-exclamation-triangle-fill'
    };

    const statusTexts = {
        'pending': 'Preparing...',
        'downloading': 'Downloading file...',
        'transcribing': 'Transcribing audio...',
        'formatting': 'Formatting text with AI...',
        'indexing': 'Indexing for search...',
        'completed': 'Completed!',
        'error': 'Error occurred'
    };

    const stepOrder = ['downloading', 'transcribing', 'formatting', 'indexing', 'completed'];

    function formatTime(seconds) {
        if (!seconds || seconds <= 0) return '--:--';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function updateSteps(currentStatus) {
        const currentIndex = stepOrder.indexOf(currentStatus);

        stepOrder.forEach((step, index) => {
            const stepEl = document.getElementById(`step-${step}`);
            if (!stepEl) return;

            stepEl.classList.remove('active', 'completed');

            if (index < currentIndex) {
                stepEl.classList.add('completed');
            } else if (index === currentIndex) {
                stepEl.classList.add('active');
            }
        });
    }

    function updateUI(data) {
        const status = data.status;
        const progress = data.progress || 0;
        const duration = data.duration_seconds;
        const currentPos = data.current_position || 0;

        // Update status icon
        const iconEl = document.getElementById('statusIcon');
        iconEl.className = `status-icon ${status} ${status !== 'completed' && status !== 'error' ? 'pulse' : ''}`;
        iconEl.innerHTML = `<i class="bi ${statusIcons[status] || 'bi-hourglass'}"></i>`;

        // Update status text
        document.getElementById('statusText').textContent = statusTexts[status] || status;

        // Update progress bar
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        if (status === 'transcribing') {
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;
        } else if (status === 'formatting') {
            // Formatting doesn't have detailed progress, show indeterminate
            progressBar.style.width = '100%';
            progressText.textContent = 'Processing...';
        } else if (status === 'indexing') {
            // Show actual indexing progress
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;
        } else if (status === 'completed') {
            progressBar.style.width = '100%';
            progressText.textContent = '100%';
            progressBar.classList.add('bg-success');
        }

        // Update time info
        if (duration && duration > 0) {
            document.getElementById('currentPosition').textContent = formatTime(currentPos);
            document.getElementById('totalDuration').textContent = formatTime(duration);
        }

        // Update steps
        updateSteps(status);

        // Handle completion
        if (status === 'completed') {
            clearInterval(pollInterval);
            setTimeout(() => {
                window.location.href = `/transcription/${transcriptionId}`;
            }, 1500);
        }

        // Handle error
        if (status === 'error') {
            clearInterval(pollInterval);
            document.getElementById('errorContainer').style.display = 'block';
            document.getElementById('errorMessage').textContent = data.error_message || 'An unknown error occurred';
            progressBar.classList.add('bg-danger');
        }
    }

    function pollStatus() {
        fetch(`/upload/status/${transcriptionId}`)
            .then(response => response.json())
            .then(data => {
                updateUI(data);
            })
            .catch(error => {
                console.error('Error polling status:', error);
            });
    }

    // Start polling
    pollInterval = setInterval(pollStatus, 1000);

    // Initial poll
    pollStatus();
</script>
{% endblock %}

